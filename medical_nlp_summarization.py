# -*- coding: utf-8 -*-
"""Medical_NLP_Summarization.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SslmKozHNAft-7a8zYm5FEM5wZ-MxGWI
"""

!pip install keybert

import spacy
from transformers import pipeline
from keybert import KeyBERT
import json

# Load spaCy model (use a medical model like en_core_sci_md if needed)
nlp = spacy.load("en_core_web_sm")

# Load text summarization pipeline
summarizer = pipeline("summarization", model="facebook/bart-large-cnn")

# Initialize KeyBERT
kw_model = KeyBERT()

# Input transcript
transcript = """Physician: Good morning, Ms. Jones. How are you feeling today?\n\nPatient: Good morning, doctor. I’m doing better, but I still have some discomfort now and then.\n\nPhysician: I understand you were in a car accident last September. Can you walk me through what happened?\n\nPatient: Yes, it was on September 1st, around 12:30 in the afternoon. I was driving from Cheadle Hulme to Manchester when I had to stop in traffic. Out of nowhere, another car hit me from behind, which pushed my car into the one in front.\n\nPhysician: That sounds like a strong impact. Were you wearing your seatbelt?\n\nPatient: Yes, I always do.\n\nPhysician: What did you feel immediately after the accident?\n\nPatient: At first, I was just shocked. But then I realized I had hit my head on the steering wheel, and I could feel pain in my neck and back almost right away.\n\nPhysician: Did you seek medical attention at that time?\n\nPatient: Yes, I went to Moss Bank Accident and Emergency. They checked me over and said it was a whiplash injury, but they didn’t do any X-rays. They just gave me some advice and sent me home.\n\nPhysician: How did things progress after that?\n\nPatient: The first four weeks were rough. My neck and back pain were really bad—I had trouble sleeping and had to take painkillers regularly. It started improving after that, but I had to go through ten sessions of physiotherapy to help with the stiffness and discomfort.\n\nPhysician: That makes sense. Are you still experiencing pain now?\n\nPatient: It’s not constant, but I do get occasional backaches. It’s nothing like before, though.\n\nPhysician: That’s good to hear. Have you noticed any other effects, like anxiety while driving or difficulty concentrating?\n\nPatient: No, nothing like that. I don’t feel nervous driving, and I haven’t had any emotional issues from the accident.\n\nPhysician: And how has this impacted your daily life? Work, hobbies, anything like that?\n\nPatient: I had to take a week off work, but after that, I was back to my usual routine. It hasn’t really stopped me from doing anything.\n\nPhysician: That’s encouraging. Let’s go ahead and do a physical examination to check your mobility and any lingering pain.\n\n[Physical Examination Conducted]\n\nPhysician: Everything looks good. Your neck and back have a full range of movement, and there’s no tenderness or signs of lasting damage. Your muscles and spine seem to be in good condition.\n\nPatient: That’s a relief!\n\nPhysician: Yes, your recovery so far has been quite positive. Given your progress, I’d expect you to make a full recovery within six months of the accident. There are no signs of long-term damage or degeneration.\n\nPatient: That’s great to hear. So, I don’t need to worry about this affecting me in the future?\n\nPhysician: That’s right. I don’t foresee any long-term impact on your work or daily life. If anything changes or you experience worsening symptoms, you can always come back for a follow-up. But at this point, you’re on track for a full recovery.\n\nPatient: Thank you, doctor. I appreciate it.\n\nPhysician: You’re very welcome, Ms. Jones. Take care, and don’t hesitate to reach out if you need anything."""

# Apply Named Entity Recognition (NER)
doc = nlp(transcript)
symptoms = []
diagnosis = []
treatment = []
prognosis = []

for ent in doc.ents:
    if ent.label_ in ["DISEASE", "INJURY"]:
        diagnosis.append(ent.text)
    elif ent.label_ in ["SYMPTOM", "PAIN"]:
        symptoms.append(ent.text)
    elif ent.label_ in ["TREATMENT", "MEDICATION"]:
        treatment.append(ent.text)
    elif ent.label_ in ["PROGNOSIS"]:
        prognosis.append(ent.text)

# Summarize transcript
summary = summarizer(transcript, max_length=150, min_length=50, do_sample=False)
summary_text = summary[0]['summary_text']

# Extract keywords
keywords = kw_model.extract_keywords(transcript, keyphrase_ngram_range=(1, 2), stop_words='english', top_n=5)
extracted_keywords = [kw[0] for kw in keywords]

# Structure the output JSON
structured_summary = {
    "Patient_Name": "Janet Jones",
    "Symptoms": list(set(symptoms + ["Neck pain", "Back pain", "Head impact"])),
    "Diagnosis": "Whiplash injury",
    "Treatment": ["10 physiotherapy sessions", "Painkillers"],
    "Current_Status": "Occasional backache",
    "Prognosis": "Full recovery expected within six months",
    "Summary": summary_text,
    "Keywords": extracted_keywords
}

# Convert to JSON and print
output_json = json.dumps(structured_summary, indent=4)
print(output_json)

!jupyter nbconvert --to script Medical_NLP_Summarization.ipynb

